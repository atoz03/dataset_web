<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>害虫图像人工核验面板</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #1f2933; color: #fff; padding: 16px 24px; }
    header h1 { margin: 0; font-size: 20px; }
    header p { margin: 6px 0 0; font-size: 14px; color: #d1d5db; }
    main { padding: 16px 24px 32px; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; }
    .controls label { font-size: 14px; margin-right: 8px; }
    select, button, input[type="file"] { font-size: 14px; padding: 6px 8px; }
    button.primary { background: #2563eb; color: #fff; border: none; cursor: pointer; }
    button.primary:hover { background: #1d4ed8; }
    button.secondary { background: #e5e7eb; border: none; cursor: pointer; }
    button.secondary:hover { background: #d1d5db; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; }
    .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(15, 23, 42, 0.2); padding: 10px; display: flex; flex-direction: column; position: relative; }
    .card .selection-checkbox { position: absolute; top: 16px; left: 16px; width: 20px; height: 20px; }
    .card img { width: 100%; height: 160px; object-fit: cover; border-radius: 6px; margin-bottom: 8px; background: #e5e7eb; }
    .card .meta { font-size: 13px; margin-bottom: 8px; color: #4b5563; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; background: #e0f2fe; color: #0369a1; }
    .actions { display: flex; gap: 8px; }
    .actions button { flex: 1; padding: 6px 0; border-radius: 4px; border: none; cursor: pointer; font-size: 13px; }
    .actions button.accept { background: #16a34a; color: #fff; }
    .actions button.reject { background: #dc2626; color: #fff; }
    .actions button.reset { background: #cbd5f5; color: #1f2937; }
    .actions button.llm { background: #0ea5e9; color: #fff; }
    .actions button.llm[disabled] { opacity: 0.6; cursor: wait; }
    .status-tag { font-size: 12px; font-weight: bold; margin-bottom: 4px; }
    .status-accepted { color: #16a34a; }
    .status-rejected { color: #dc2626; }
    .status-pending { color: #2563eb; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .file-input { display: inline-flex; align-items: center; gap: 6px; }
    .analysis { margin-top: 10px; padding: 10px; border-radius: 6px; background: #f1f5f9; font-size: 13px; color: #1f2937; display: flex; flex-direction: column; gap: 8px; }
    .analysis.match { border: 1px solid #34d399; }
    .analysis.mismatch { border: 1px solid #f97316; }
    .analysis.error { border: 1px solid #dc2626; background: #fee2e2; color: #991b1b; }
    .analysis .title { font-weight: bold; font-size: 14px; }
    .analysis .description { line-height: 1.4; }
    .analysis .quality { font-size: 12px; color: #4b5563; }
    .analysis .controls { display: flex; flex-direction: column; gap: 6px; }
    .analysis .controls label { font-size: 12px; color: #374151; }
    .analysis .controls input,
    .analysis .controls select { padding: 4px 6px; font-size: 13px; border-radius: 4px; border: 1px solid #cbd5f5; }
    .analysis .controls button { align-self: flex-start; padding: 6px 10px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; background: #2563eb; color: #fff; }
    .analysis .controls button[disabled] { opacity: 0.6; cursor: wait; }
    .analysis .mock-note { font-size: 12px; color: #6b7280; }
    footer { margin-top: 32px; font-size: 12px; color: #6b7280; text-align: center; }
  </style>
</head>
<body>
  <script src="../web_scraper/pest_review_manifest.js"></script>
  <header>
    <h1>害虫图像人工核验面板</h1>
    <p>逐张核验新抓取的害虫图像，标记“通过 / 剔除”，下载结果 JSON 后即可交由脚本并入主数据集。</p>
  </header>
  <main>
    <section class="controls">
      <div>
        <label for="keyword-select">类别</label>
        <select id="keyword-select"></select>
      </div>
      <div>
        <label for="status-filter">状态</label>
        <select id="status-filter">
          <option value="all">全部</option>
          <option value="pending">待审核</option>
          <option value="accepted">已通过</option>
          <option value="rejected">已剔除</option>
        </select>
      </div>
      <div>
        <button id="download-json" class="primary">下载审核结果 JSON</button>
      </div>
      <div class="file-input">
        <label for="upload-json" class="secondary" style="padding:6px 10px; border-radius:4px; cursor:pointer;">导入已有结果</label>
        <input type="file" id="upload-json" accept="application/json" style="display:none;" />
      </div>
      <div>
        <button id="reset-all" class="secondary">重置当前类别</button>
      </div>
      <div>
        <button id="bulk-analyze" class="primary">分析选中项</button>
      </div>
      <div>
        <button id="select-all" class="secondary">全选</button>
      </div>
    </section>

    <section class="gallery" id="gallery"></section>

    <footer>
      <p>评分数据保存在浏览器 localStorage 中。下载 JSON 后即可交由 `scripts/import_reviewed_pests.py` 脚本自动整理进数据集。</p>
    </footer>
  </main>

  <script>
    const BASE_PATH = '../';
    /* eslint-disable no-undef */
    const manifest = (typeof pestReviewManifest !== 'undefined' && Array.isArray(pestReviewManifest))
      ? pestReviewManifest
      : (Array.isArray(window.pestReviewManifest) ? window.pestReviewManifest : []);

    const keywordSelect = document.getElementById('keyword-select');
    const statusFilter = document.getElementById('status-filter');
    const gallery = document.getElementById('gallery');
    const downloadButton = document.getElementById('download-json');
    const uploadInput = document.getElementById('upload-json');
    const resetButton = document.getElementById('reset-all');
    const bulkAnalyzeButton = document.getElementById('bulk-analyze');
    const selectAllButton = document.getElementById('select-all');

    const stateKey = 'pest-review-state.v1';
    const analysisCache = {};
    const pendingAnalysis = new Set();
    const pendingReclassify = new Set();
    let state = {};

    try {
      state = JSON.parse(localStorage.getItem(stateKey) || '{}');
    } catch (err) {
      console.error('Failed to load saved state', err);
      state = {};
    }

    function resolveApiBase() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('api')) {
        return params.get('api');
      }
      if (window.pestReviewConfig?.apiBase) {
        return window.pestReviewConfig.apiBase;
      }
      return 'http://localhost:5178/api';
    }

    const API_BASE = resolveApiBase();

    function computeKeywordStats() {
      const counts = new Map();
      manifest.forEach(item => {
        const key = item.keyword;
        counts.set(key, (counts.get(key) || 0) + 1);
      });
      return Array.from(counts.entries())
        .map(([keyword, count]) => ({ keyword, count }))
        .sort((a, b) => a.keyword.localeCompare(b.keyword));
    }

    function populateKeywordOptions(preserveSelection = true) {
      const current = preserveSelection ? keywordSelect.value : '';
      const stats = computeKeywordStats();
      keywordSelect.innerHTML = '';
      if (stats.length === 0) {
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = '无待审条目';
        keywordSelect.appendChild(placeholder);
        keywordSelect.value = '';
        return;
      }
      stats.forEach(({ keyword, count }) => {
        const option = document.createElement('option');
        option.value = keyword;
        option.textContent = `${keyword} (${count})`;
        keywordSelect.appendChild(option);
      });
      if (current && stats.some(item => item.keyword === current)) {
        keywordSelect.value = current;
      } else {
        keywordSelect.value = stats[0].keyword;
      }
    }

    function saveState() {
      localStorage.setItem(stateKey, JSON.stringify(state));
    }

    function getStatus(id) {
      return state[id]?.status || 'pending';
    }

    function statusLabel(status) {
      if (status === 'accepted') return '已通过';
      if (status === 'rejected') return '已剔除';
      return '待审核';
    }

    function statusClass(status) {
      if (status === 'accepted') return 'status-accepted';
      if (status === 'rejected') return 'status-rejected';
      return 'status-pending';
    }

    function setStatus(id, status) {
      if (!state[id]) {
        state[id] = {};
      }
      state[id].status = status;
      state[id].ts = Date.now();
      saveState();
      renderGallery();
    }

    function clearStatusForKeyword(keyword) {
      manifest.filter(item => item.keyword === keyword).forEach(item => {
        if (state[item.id]) {
          delete state[item.id];
        }
        if (analysisCache[item.id]) {
          delete analysisCache[item.id];
        }
      });
      saveState();
      renderGallery();
    }

    function resetStateForItem(id) {
      if (state[id]) {
        delete state[id];
        saveState();
      }
    }

    function updateManifestItem(id, updates) {
      const target = manifest.find(entry => entry.id === id);
      if (target) {
        Object.assign(target, updates);
      }
    }

    function renderAnalysisBlock(card, item) {
      card.querySelectorAll('.analysis').forEach(el => el.remove());
      const record = analysisCache[item.id];
      if (!record) {
        return;
      }

      const analysisEl = document.createElement('div');
      analysisEl.className = 'analysis';

      if (record.status === 'error') {
        analysisEl.classList.add('error');
        analysisEl.innerHTML = `<div class="title">LLM 分析失败</div><div>${record.message}</div>`;
        card.appendChild(analysisEl);
        return;
      }

      const data = record.data;
      const isMatch = Boolean(data?.is_match);
      analysisEl.classList.add(isMatch ? 'match' : 'mismatch');

      const title = document.createElement('div');
      title.className = 'title';
      title.textContent = isMatch ? 'LLM 判定：与当前类目匹配' : 'LLM 判定：疑似不匹配';
      analysisEl.appendChild(title);

      const desc = document.createElement('div');
      desc.className = 'description';
      const zh = data?.description_zh || '';
      const en = data?.description_en || '';
      desc.innerHTML = [zh, en].filter(Boolean).map(text => `<div>${text}</div>`).join('');
      analysisEl.appendChild(desc);

      if (typeof data?.quality_score === 'number') {
        const q = document.createElement('div');
        q.className = 'quality';
        const quality = (data.quality_score * 100).toFixed(0);
        const reason = data.rejection_reason ? ` · ${data.rejection_reason}` : '';
        q.textContent = `质量评分：${quality} / 100${reason}`;
        analysisEl.appendChild(q);
      }

      if (data?.mock) {
        const mockNote = document.createElement('div');
        mockNote.className = 'mock-note';
        mockNote.textContent = '（当前为离线 Mock 响应，需在服务器端配置真实 VLM 密钥以启用正式分析）';
        analysisEl.appendChild(mockNote);
      }

      const controls = document.createElement('div');
      controls.className = 'controls';

      const targetLabel = document.createElement('label');
      targetLabel.textContent = '目标类目（可修改）';
      controls.appendChild(targetLabel);

      const targetInput = document.createElement('input');
      targetInput.value = data?.actual_class || item.keyword;
      controls.appendChild(targetInput);

      const renameLabel = document.createElement('label');
      renameLabel.textContent = '重命名策略';
      controls.appendChild(renameLabel);

      const renameSelect = document.createElement('select');
      renameSelect.innerHTML = `
        <option value="keep">保留原文件名</option>
        <option value="uuid">生成规范名称（含 UUID）</option>
        <option value="custom">自定义文件名</option>
      `;
      controls.appendChild(renameSelect);

      const customInput = document.createElement('input');
      customInput.placeholder = '例如: caterpillar__web__xxxx.jpg';
      customInput.style.display = 'none';
      controls.appendChild(customInput);

      renameSelect.addEventListener('change', () => {
        customInput.style.display = renameSelect.value === 'custom' ? 'block' : 'none';
      });

      const applyBtn = document.createElement('button');
      applyBtn.textContent = '执行移动/重命名';
      if (pendingReclassify.has(item.id)) {
        applyBtn.disabled = true;
      }

      applyBtn.addEventListener('click', () => {
        const targetClass = targetInput.value.trim();
        if (!targetClass) {
          alert('目标类目不能为空');
          return;
        }
        const renameMode = renameSelect.value;
        const customName = renameMode === 'custom' ? customInput.value.trim() : undefined;
        reclassifyItem(item, targetClass, renameMode, customName);
      });

      controls.appendChild(applyBtn);
      analysisEl.appendChild(controls);

      if (record.applied) {
        const appliedNote = document.createElement('div');
        appliedNote.className = 'quality';
        appliedNote.textContent = '已应用最新移动操作。';
        analysisEl.appendChild(appliedNote);
      }
      card.appendChild(analysisEl);
    }

    async function analyzeItems(items) {
      if (!items || items.length === 0) {
        alert('请先选择要分析的图片');
        return;
      }
      if (!API_BASE) {
        alert('未检测到后端服务，请先启动 pest_review_server.py');
        return;
      }

      items.forEach(item => pendingAnalysis.add(item.id));
      renderGallery();

      try {
        const response = await fetch(`${API_BASE}/analyze`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items.map(item => ({ path: item.path, keyword: item.keyword })) }),
        });
        const payload = await response.json();
        if (!response.ok) {
          const message = payload?.message || payload?.error || `HTTP ${response.status}`;
          throw new Error(message);
        }
        
        // Process bulk results
        payload.data.forEach(result => {
          const item = manifest.find(i => i.path === result.path);
          if (item) {
            if (result.error) {
              analysisCache[item.id] = { status: 'error', message: result.error };
            } else {
              analysisCache[item.id] = { status: 'ok', data: result.analysis };
            }
          }
        });

      } catch (error) {
        const message = error?.message || '未知错误';
        // Apply error to all selected items for user feedback
        items.forEach(item => {
          analysisCache[item.id] = { status: 'error', message };
        });
      } finally {
        items.forEach(item => pendingAnalysis.delete(item.id));
        renderGallery();
      }
    }

    function analyzeItem(item) {
      return analyzeItems([item]);
    }

    async function reclassifyItem(item, targetClass, renameMode, customName) {
      pendingReclassify.add(item.id);
      renderGallery();
      try {
        const response = await fetch(`${API_BASE}/reclassify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: item.id,
            path: item.path,
            target_class: targetClass,
            rename_mode: renameMode,
            custom_name: customName,
          }),
        });
        const payload = await response.json();
        if (!response.ok) {
          const message = payload?.message || payload?.error || `HTTP ${response.status}`;
          throw new Error(message);
        }
        const outcome = payload.data;
        updateManifestItem(item.id, {
          keyword: outcome.target_class,
          path: outcome.new_path,
        });
        resetStateForItem(item.id);
        if (analysisCache[item.id]) {
          analysisCache[item.id].applied = true;
        }
        populateKeywordOptions();
        renderGallery();
        alert(`已移动：${item.id} → ${outcome.new_path}`);
      } catch (error) {
        const message = error?.message || '操作失败';
        alert(`移动失败：${message}`);
      } finally {
        pendingReclassify.delete(item.id);
        renderGallery();
      }
    }

    function renderGallery() {
      const keyword = keywordSelect.value;
      const filter = statusFilter.value;
      gallery.innerHTML = '';

      if (!keyword) {
        const empty = document.createElement('div');
        empty.textContent = '暂无待审核图片';
        empty.style.padding = '12px';
        empty.style.color = '#6b7280';
        gallery.appendChild(empty);
        return;
      }

      const filtered = manifest.filter(item => item.keyword === keyword);
      filtered.forEach(item => {
        const currentStatus = getStatus(item.id);
        if (filter !== 'all' && currentStatus !== filter) {
          return;
        }
        const card = document.createElement('div');
        card.className = 'card';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'selection-checkbox';
        checkbox.dataset.itemId = item.id;
        card.appendChild(checkbox);

        const statusEl = document.createElement('div');
        statusEl.className = `status-tag ${statusClass(currentStatus)}`;
        statusEl.textContent = statusLabel(currentStatus);
        card.appendChild(statusEl);

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.src = BASE_PATH + item.path;
        img.alt = `${item.keyword} image`;
        card.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `
          <span class="pill">${item.keyword}</span>
          <span class="pill">${item.source}</span>
          <div style="margin-top:4px;">${item.path}</div>
        `;
        card.appendChild(meta);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const acceptBtn = document.createElement('button');
        acceptBtn.className = 'accept';
        acceptBtn.textContent = '通过';
        acceptBtn.onclick = () => setStatus(item.id, 'accepted');

        const rejectBtn = document.createElement('button');
        rejectBtn.className = 'reject';
        rejectBtn.textContent = '剔除';
        rejectBtn.onclick = () => setStatus(item.id, 'rejected');

        const resetBtn = document.createElement('button');
        resetBtn.className = 'reset';
        resetBtn.textContent = '重置';
        resetBtn.onclick = () => setStatus(item.id, 'pending');

        const llmBtn = document.createElement('button');
        llmBtn.className = 'llm';
        const isAnalyzing = pendingAnalysis.has(item.id);
        llmBtn.textContent = isAnalyzing ? '分析中…' : 'LLM 分析';
        llmBtn.disabled = isAnalyzing;
        llmBtn.onclick = () => analyzeItem(item);

        actions.appendChild(acceptBtn);
        actions.appendChild(rejectBtn);
        actions.appendChild(resetBtn);
        actions.appendChild(llmBtn);
        card.appendChild(actions);

        renderAnalysisBlock(card, item);
        gallery.appendChild(card);
      });
    }

    keywordSelect.addEventListener('change', renderGallery);
    statusFilter.addEventListener('change', renderGallery);

    downloadButton.addEventListener('click', () => {
      const output = manifest.map(item => ({
        id: item.id,
        keyword: item.keyword,
        source: item.source,
        path: item.path,
        status: getStatus(item.id),
      }));
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const now = new Date().toISOString().replace(/[:.]/g, '-');
      a.download = `pest_review_${now}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    uploadInput.addEventListener('change', (event) => {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) {
            alert('JSON 数据格式错误，应为数组');
            return;
          }
          data.forEach(entry => {
            if (!entry.id) return;
            if (!state[entry.id]) {
              state[entry.id] = {};
            }
            state[entry.id].status = entry.status || 'pending';
            state[entry.id].ts = Date.now();
          });
          saveState();
          renderGallery();
        } catch (err) {
          console.error(err);
          alert('解析 JSON 失败');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    });

    resetButton.addEventListener('click', () => {
      const keyword = keywordSelect.value;
      if (!keyword) return;
      if (confirm(`确定重置类别 “${keyword}” 的全部审核记录？`)) {
        clearStatusForKeyword(keyword);
      }
    });

    bulkAnalyzeButton.addEventListener('click', () => {
       const selectedCheckboxes = gallery.querySelectorAll('.selection-checkbox:checked');
       if (selectedCheckboxes.length === 0) {
         alert('请至少选择一张图片进行分析。');
         return;
       }
       const itemsToAnalyze = Array.from(selectedCheckboxes).map(cb => {
         const itemId = cb.dataset.itemId;
         return manifest.find(item => item.id === itemId);
       }).filter(Boolean);
       
       analyzeItems(itemsToAnalyze);
    });

   selectAllButton.addEventListener('click', () => {
       const checkboxes = gallery.querySelectorAll('.selection-checkbox');
       if (checkboxes.length === 0) return;
       
       const allSelected = Array.from(checkboxes).every(cb => cb.checked);
       checkboxes.forEach(cb => {
           cb.checked = !allSelected;
       });
   });

    populateKeywordOptions(false);
    renderGallery();
  </script>
</body>
</html>
